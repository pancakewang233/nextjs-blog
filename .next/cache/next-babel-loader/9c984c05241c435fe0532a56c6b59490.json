{"ast":null,"code":"import { getDatabaseConnection } from '../../../lib/getDatabaseConnection';\nimport { User } from 'src/entity/User';\nimport md5 from 'md5';\n\nconst Users = async (req, res) => {\n  const connection = await getDatabaseConnection();\n  const {\n    username,\n    password,\n    passwordConfirmation\n  } = req.body;\n  const errors = {\n    username: [],\n    password: [],\n    passwordConfirmation: []\n  };\n\n  if (username.trim() === '') {\n    errors.username.push('不能为空');\n  }\n\n  if (!/[a-zA-Z0-9]/.test(username.trim())) {\n    errors.username.push('格式不合法');\n  }\n\n  if (username.trim().length > 24) {\n    errors.username.push('太长');\n  }\n\n  if (username.trim().length <= 3) {\n    errors.username.push('太短');\n  }\n\n  const found = connection.manager.find(User, {\n    username\n  });\n\n  if (found) {\n    errors.username.push('已存在，不能重复注册');\n  }\n\n  if (password === '') {\n    errors.password.push('不能为空');\n  }\n\n  if (password !== passwordConfirmation) {\n    errors.passwordConfirmation.push('密码不匹配');\n  }\n\n  const hasErrors = Object.values(errors).find(v => v.length > 0);\n  res.setHeader('Content-Type', 'application/json;charset=utf-8');\n\n  if (hasErrors) {\n    res.statusCode = 422;\n    res.write(JSON.stringify(errors));\n    res.end();\n  } else {\n    const user = new User();\n    user.username = username.trim();\n    user.passwordDigest = md5(password);\n    await connection.manager.save(user);\n    res.statusCode = 200;\n    res.write(JSON.stringify(user));\n  }\n\n  res.end();\n};\n\nexport default Users;","map":{"version":3,"sources":["D:/Pank/code/Pack/nextjs-blog/pages/api/v1/users.tsx"],"names":["getDatabaseConnection","User","md5","Users","req","res","connection","username","password","passwordConfirmation","body","errors","trim","push","test","length","found","manager","find","hasErrors","Object","values","v","setHeader","statusCode","write","JSON","stringify","end","user","passwordDigest","save"],"mappings":"AACA,SAAQA,qBAAR,QAAoC,oCAApC;AACA,SAAQC,IAAR,QAAmB,iBAAnB;AACA,OAAOC,GAAP,MAAgB,KAAhB;;AAEA,MAAMC,KAAK,GAAG,OAAOC,GAAP,EAA4BC,GAA5B,KAAqD;AACjE,QAAMC,UAAU,GAAG,MAAMN,qBAAqB,EAA9C;AACA,QAAM;AAACO,IAAAA,QAAD;AAAWC,IAAAA,QAAX;AAAqBC,IAAAA;AAArB,MAA6CL,GAAG,CAACM,IAAvD;AACA,QAAMC,MAAM,GAAG;AACbJ,IAAAA,QAAQ,EAAE,EADG;AACaC,IAAAA,QAAQ,EAAE,EADvB;AACuCC,IAAAA,oBAAoB,EAAE;AAD7D,GAAf;;AAGA,MAAIF,QAAQ,CAACK,IAAT,OAAoB,EAAxB,EAA4B;AAC1BD,IAAAA,MAAM,CAACJ,QAAP,CAAgBM,IAAhB,CAAqB,MAArB;AACD;;AACD,MAAI,CAAC,cAAcC,IAAd,CAAmBP,QAAQ,CAACK,IAAT,EAAnB,CAAL,EAA0C;AACxCD,IAAAA,MAAM,CAACJ,QAAP,CAAgBM,IAAhB,CAAqB,OAArB;AACD;;AACD,MAAIN,QAAQ,CAACK,IAAT,GAAgBG,MAAhB,GAAyB,EAA7B,EAAiC;AAC/BJ,IAAAA,MAAM,CAACJ,QAAP,CAAgBM,IAAhB,CAAqB,IAArB;AACD;;AACD,MAAIN,QAAQ,CAACK,IAAT,GAAgBG,MAAhB,IAA0B,CAA9B,EAAiC;AAC/BJ,IAAAA,MAAM,CAACJ,QAAP,CAAgBM,IAAhB,CAAqB,IAArB;AACD;;AACD,QAAMG,KAAK,GAAGV,UAAU,CAACW,OAAX,CAAmBC,IAAnB,CAAwBjB,IAAxB,EAA8B;AAACM,IAAAA;AAAD,GAA9B,CAAd;;AACA,MAAIS,KAAJ,EAAW;AACTL,IAAAA,MAAM,CAACJ,QAAP,CAAgBM,IAAhB,CAAqB,YAArB;AACD;;AACD,MAAIL,QAAQ,KAAK,EAAjB,EAAqB;AACnBG,IAAAA,MAAM,CAACH,QAAP,CAAgBK,IAAhB,CAAqB,MAArB;AACD;;AACD,MAAIL,QAAQ,KAAKC,oBAAjB,EAAuC;AACrCE,IAAAA,MAAM,CAACF,oBAAP,CAA4BI,IAA5B,CAAiC,OAAjC;AACD;;AACD,QAAMM,SAAS,GAAGC,MAAM,CAACC,MAAP,CAAcV,MAAd,EAAsBO,IAAtB,CAA2BI,CAAC,IAAIA,CAAC,CAACP,MAAF,GAAW,CAA3C,CAAlB;AACAV,EAAAA,GAAG,CAACkB,SAAJ,CAAc,cAAd,EAA8B,gCAA9B;;AACA,MAAIJ,SAAJ,EAAe;AACbd,IAAAA,GAAG,CAACmB,UAAJ,GAAiB,GAAjB;AACAnB,IAAAA,GAAG,CAACoB,KAAJ,CAAUC,IAAI,CAACC,SAAL,CAAehB,MAAf,CAAV;AACAN,IAAAA,GAAG,CAACuB,GAAJ;AACD,GAJD,MAIO;AAEL,UAAMC,IAAI,GAAG,IAAI5B,IAAJ,EAAb;AACA4B,IAAAA,IAAI,CAACtB,QAAL,GAAgBA,QAAQ,CAACK,IAAT,EAAhB;AACAiB,IAAAA,IAAI,CAACC,cAAL,GAAsB5B,GAAG,CAACM,QAAD,CAAzB;AAEA,UAAMF,UAAU,CAACW,OAAX,CAAmBc,IAAnB,CAAwBF,IAAxB,CAAN;AACAxB,IAAAA,GAAG,CAACmB,UAAJ,GAAiB,GAAjB;AACAnB,IAAAA,GAAG,CAACoB,KAAJ,CAAUC,IAAI,CAACC,SAAL,CAAeE,IAAf,CAAV;AACD;;AACDxB,EAAAA,GAAG,CAACuB,GAAJ;AACD,CA7CD;;AA+CA,eAAezB,KAAf","sourcesContent":["import {NextApiRequest, NextApiResponse} from 'next';\r\nimport {getDatabaseConnection} from '../../../lib/getDatabaseConnection';\r\nimport {User} from 'src/entity/User';\r\nimport md5 from 'md5';\r\n\r\nconst Users = async (req: NextApiRequest, res: NextApiResponse) => {\r\n  const connection = await getDatabaseConnection();\r\n  const {username, password, passwordConfirmation} = req.body;\r\n  const errors = {\r\n    username: [] as string[], password: [] as string[], passwordConfirmation: [] as string[]\r\n  };\r\n  if (username.trim() === '') {\r\n    errors.username.push('不能为空');\r\n  }\r\n  if (!/[a-zA-Z0-9]/.test(username.trim())) {\r\n    errors.username.push('格式不合法');\r\n  }\r\n  if (username.trim().length > 24) {\r\n    errors.username.push('太长');\r\n  }\r\n  if (username.trim().length <= 3) {\r\n    errors.username.push('太短');\r\n  }\r\n  const found = connection.manager.find(User, {username});\r\n  if (found) {\r\n    errors.username.push('已存在，不能重复注册');\r\n  }\r\n  if (password === '') {\r\n    errors.password.push('不能为空');\r\n  }\r\n  if (password !== passwordConfirmation) {\r\n    errors.passwordConfirmation.push('密码不匹配');\r\n  }\r\n  const hasErrors = Object.values(errors).find(v => v.length > 0);\r\n  res.setHeader('Content-Type', 'application/json;charset=utf-8');\r\n  if (hasErrors) {\r\n    res.statusCode = 422;\r\n    res.write(JSON.stringify(errors));\r\n    res.end();\r\n  } else {\r\n\r\n    const user = new User();\r\n    user.username = username.trim();\r\n    user.passwordDigest = md5(password);\r\n\r\n    await connection.manager.save(user);\r\n    res.statusCode = 200;\r\n    res.write(JSON.stringify(user));\r\n  }\r\n  res.end();\r\n};\r\n\r\nexport default Users;\r\n"]},"metadata":{},"sourceType":"module"}